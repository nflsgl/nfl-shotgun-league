<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Home - Shotgun League</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #logoutBtn {
      background: none;
      border: none;
      color: #00f;
      text-decoration: underline;
      cursor: pointer;
      font: inherit;
      padding: 0;
    }
    #pickNotice {
      margin-top: 1em;
      font-weight: bold;
    }
    .team-logo {
      display: inline-block;
      vertical-align: middle;
      width: 28px;
      height: 28px;
      margin-right: 8px;
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        display: none;
      }
      td {
        padding: 10px;
        border-bottom: 1px solid #ccc;
      }
      td::before {
        font-weight: bold;
        display: block;
      }
      td:nth-child(1)::before { content: "Week"; }
      td:nth-child(2)::before { content: "Team"; }
    }
  </style>
  <script src="/nfl-shotgun-league/schedule.js"></script>
  <script>
    const teamLogos = {
      "Arizona Cardinals": "cardinals.png",
      "Atlanta Falcons": "falcons.png",
      "Baltimore Ravens": "ravens.png",
      "Buffalo Bills": "bills.png",
      "Carolina Panthers": "panthers.png",
      "Chicago Bears": "bears.png",
      "Cincinnati Bengals": "bengals.png",
      "Cleveland Browns": "browns.png",
      "Dallas Cowboys": "cowboys.png",
      "Denver Broncos": "broncos.png",
      "Detroit Lions": "lions.png",
      "Green Bay Packers": "packers.png",
      "Houston Texans": "texans.png",
      "Indianapolis Colts": "colts.png",
      "Jacksonville Jaguars": "jaguars.png",
      "Kansas City Chiefs": "chiefs.png",
      "Las Vegas Raiders": "raiders.png",
      "Los Angeles Chargers": "chargers.png",
      "Los Angeles Rams": "rams.png",
      "Miami Dolphins": "dolphins.png",
      "Minnesota Vikings": "vikings.png",
      "New England Patriots": "patriots.png",
      "New Orleans Saints": "saints.png",
      "New York Giants": "giants.png",
      "New York Jets": "jets.png",
      "Philadelphia Eagles": "eagles.png",
      "Pittsburgh Steelers": "steelers.png",
      "San Francisco 49ers": "49ers.png",
      "Seattle Seahawks": "seahawks.png",
      "Tampa Bay Buccaneers": "buccaneers.png",
      "Tennessee Titans": "titans.png",
      "Washington Commanders": "commanders.png"
    };

    document.addEventListener("DOMContentLoaded", async function () {
      const user = localStorage.getItem("user");
      const loginTime = parseInt(localStorage.getItem("loginTime"), 10);
      const now = Date.now();
      const oneHour = 60 * 60 * 1000;

      if (!user || !loginTime || now - loginTime > oneHour) {
        localStorage.clear();
        window.location.href = "/nfl-shotgun-league/index.html";
        return;
      }

      document.getElementById("welcome").textContent = "Welcome, " + user;

      document.getElementById("logoutBtn").addEventListener("click", function () {
        if (confirm("Are you sure you want to log out?")) {
          localStorage.removeItem("user");
          localStorage.removeItem("loginTime");
          window.location.href = "/nfl-shotgun-league/index.html";
        }
      });

      // Determine current week
      const today = new Date();
      let currentWeek = null;
      for (const [week, games] of Object.entries(schedule)) {
        for (const game of games) {
          const gameDate = new Date(game.date);
          if (today <= gameDate) {
            currentWeek = week;
            break;
          }
        }
        if (currentWeek) break;
      }

      if (!currentWeek) {
        const weeks = Object.keys(schedule).sort((a, b) => parseInt(a) - parseInt(b));
        currentWeek = weeks[weeks.length - 1];
      }

      localStorage.setItem("currentWeek", currentWeek);

      startCountdowns(currentWeek);
      
      // Fetch pick history from Google Apps Script
      fetch(`https://script.google.com/macros/s/AKfycbxlxW1BRCg03ScwtukXcWrUsEh_59j9gzAhoXbjzU_DMHFLwJe_ngVDHS9LntUhYVcy/exec?username=${encodeURIComponent(user)}`)
        .then(res => res.json())
        .then(picks => {
          const thisWeekPick = picks.find(p => p.week == currentWeek);
          const pickMsg = document.createElement("p");
          pickMsg.id = "pickNotice";

          if (thisWeekPick) {
            const pickedTeam = thisWeekPick.team;
            const logoFile = teamLogos[pickedTeam] || "default.png";
            const logoImg = `<img src="/nfl-shotgun-league/logos/${logoFile}" alt="${pickedTeam}" class="team-logo">`;
            pickMsg.innerHTML = `
              ${logoImg}
              You have already selected <strong>${pickedTeam}</strong> for Week ${currentWeek}.<br>
              If you want to change your pick, press <a href="/nfl-shotgun-league/pick.html">Submit Pick</a> again.<br>
              You will not be able to change your pick once your selected team has kicked off.
            `;
          } else {
            pickMsg.innerHTML = `
              ‚ö†Ô∏è You have not yet made a pick for Week ${currentWeek}.<br>
              Please go to <a href="/nfl-shotgun-league/pick.html">Submit Pick</a> to lock one in before kickoff.
            `;
          }

          document.getElementById("welcome").insertAdjacentElement("afterend", pickMsg);

          // Commish link
          if (user === "alecb" || user === "mitchm") {
            const commishLink = document.createElement("p");
            commishLink.innerHTML = `<a href="/nfl-shotgun-league/commissioner.html">üõ†Ô∏è Commissioner Panel</a>`;
            pickMsg.insertAdjacentElement("afterend", commishLink);
          }

          // Render full pick history
          const tableBody = document.querySelector("#userPicksTable tbody");
          const sorted = [...picks].sort((a, b) => parseInt(a.week) - parseInt(b.week));
          sorted.forEach(p => {
            const row = document.createElement("tr");
            if (p.week == currentWeek) {
              row.style.backgroundColor = "#e0ffe0";
              row.style.fontWeight = "bold";
            }

            const logoFile = teamLogos[p.team] || "default.png";
            row.innerHTML = `
              <td>Week ${p.week}</td>
              <td>
                <img src="/nfl-shotgun-league/logos/${logoFile}" alt="${p.team}" style="width: 24px; vertical-align: middle; margin-right: 8px;">
                ${p.team}
              </td>
            `;
            tableBody.appendChild(row);
          });
        })
        .catch(err => {
          console.error("Error fetching pick:", err);
          const errorMsg = document.createElement("p");
          errorMsg.id = "pickNotice";
          errorMsg.textContent = "‚ö†Ô∏è Unable to load your pick. Please try refreshing.";
          document.getElementById("welcome").insertAdjacentElement("afterend", errorMsg);
        });
    });

    function startCountdowns(weekNum) {
      const games = schedule[weekNum];
      if (!games || games.length === 0) return;
    
      const countdownBox = document.getElementById("countdownBox");
    
      // Get first Thursday game (or fallback to first game)
      const thursdayGame = games.find(g => new Date(g.date).getDay() === 4) || games[0];
      const sunday1pm = new Date(games.find(g => new Date(g.date).getDay() === 0)?.date || games[0].date);
      sunday1pm.setHours(13, 0, 0, 0); // force Sunday at 1PM
    
      function updateCountdowns() {
        const now = new Date();
        const t1 = Math.max(0, new Date(thursdayGame.date) - now);
        const t2 = Math.max(0, sunday1pm - now);
    
        function format(ms) {
          const totalSec = Math.floor(ms / 1000);
          const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
          const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
          const s = String(totalSec % 60).padStart(2, '0');
          return `${h}:${m}:${s}`;
        }
    
        countdownBox.innerHTML = `
          ‚è±Ô∏è Time until Thursday Night Game: <span style="color:${t1 < 3600000 ? 'red' : 'inherit'}">${format(t1)}</span><br>
          üïê Time until Sunday 1 PM ET: <span style="color:${t2 < 3600000 ? 'red' : 'inherit'}">${format(t2)}</span>
        `;
      }
    
      updateCountdowns();
      setInterval(updateCountdowns, 1000);
    }

  </script>
</head>
<body>
  <div id="nav">
    <a href="/nfl-shotgun-league/pick.html">Submit Pick</a> |
    <a href="/nfl-shotgun-league/leaderboard.html">Leaderboard</a> |
    <a href="/nfl-shotgun-league/matrix.html">Matrix</a> |
    <button id="logoutBtn">Logout</button>
  </div>
  <h1 id="welcome">Welcome</h1>
  <div id="countdownBox" style="margin: 1em 0; font-weight: bold;"></div>
  <p>This is your league home page. Use the nav above to explore your picks and standings.</p>

  <h2>Your Picks</h2>
  <table id="userPicksTable" style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="text-align:left; border-bottom: 2px solid #ccc;">Week</th>
        <th style="text-align:left; border-bottom: 2px solid #ccc;">Team</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</body>
</html>
